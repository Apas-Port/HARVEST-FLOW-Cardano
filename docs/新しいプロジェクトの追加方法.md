# 新しいプロジェクトの追加方法（hf-cli ベース）

Harvestflow で新しいプロジェクトを公開するときは、ローカル環境の準備、オンチェーンの初期化、
そして Vercel への反映という順序で作業します。ここでは `scripts/hf-cli.cjs` を使った手順を説明します。

## 0. 事前準備

最初にリポジトリをそろえます。このフロントエンド（`cardano-next`）と `../../HF-cardano-backend` を同じ階層に配置し、どちらでも `pnpm install` を実行して依存関係を解決してください。次に、プロジェクト直下の `.env` または `.env.local` に以下の環境変数を設定し、必要に応じて値を書き換えます。

```
CARDANO_NETWORK=preprod
BLOCKFROST_API_KEY=<preprod 用キー>
BLOCKFROST_PREPROD_API_KEY=<任意>
BLOCKFROST_MAINNET_API_KEY=<任意>
COLLECTION_NAME=<コレクション名>
PAYMENT_MNEMONIC="<24語のニーモニック>"
PAYMENT_ACCOUNT_INDEX=0
PAYMENT_ADDRESS_INDEX=0
# PAYMENT_MNEMONIC_PASSPHRASE=
FEE_PRICE_LOVELACE=1969750
EXPECTED_APR_NUMERATOR=1
EXPECTED_APR_DENOMINATOR=10
MATURATION_TIME=2338311809
MAX_MINTS=100
PARAM_UTXO_ENV_KEY=PARAM_UTXO_DEFAULT
```

Lace などで複数アカウントを運用している場合は、`PAYMENT_ACCOUNT_INDEX` と `PAYMENT_ADDRESS_INDEX` を実際の利用状況に合わせて変更します。設定が終わったら `scripts` ディレクトリに移動し、`pnpm install` を実行して CLI の依存関係も解決してください。以降のコマンドはすべて `scripts/` で実行します。

### 1 Dummyの `paramUtxo.json` を設置
RootDirectry に paramUtxo.json を設置する
```json
{"outputIndex":1,"txHash":"dd5fb7a9a0af6ae8fc215794c84a22412e1e5f383f098833333a576226c35e9f"}
```

## 2. プロジェクト JSON の編集

新しいプロジェクトを追加するときは、まず `public/data/dev-projects.json` に次のようなオブジェクトを追加します。`id` は 32 文字で一意にします。

```json
{
  "id": "00000000000000000000000000000002",
  "num": 2,
  "title": "プロジェクト名",
  "subTitle": "サブタイトル",
  "description": "プロジェクト概要",
  "apy": 8.0,
  "lendingType": "ADA",
  "network": "Cardano",
  "capacity": 300,
  "unitPrice": 1,
  "collectionName": "Harvestflow",
  "mainImage": "/images/project/2/main.png",
  "previewImage": "/images/project/2/preview.jpg",
  "tuktukImage": "/images/project/2/tuktuk.png",
  "policyId": "",
  "status": "active",
  "listing": true,
  "maxMints": 100,
  "paramUtxoEnvKey": "PARAM_UTXO_PROJECT_2",
  "mintPriceLovelace": 1969750
}
```

画像は `public/images/project/<num>/` に配置します。将来的に mainnet へ公開するときは、同じ構造を `public/data/projects.json` にコピーしてください。

## 3. hf-cli によるオンチェーン初期化

### 3.1 ウォレット残高の確認

`pnpm run hf -- balance --network=preprod`

上記のコマンドを実行すると、資金用ウォレットのアドレスと残高が表示されます。表示されたアドレスに十分な ADA が入っていることを確認し、Lace で表示される受取アドレスと一致するかどうかを必ずチェックします。

*Example
```shell
% pnpm run hf -- balance --network=preprod

> hf-cli@ hf /Users/mizuki/workspace/cardano-next/scripts
> node hf-cli.cjs "--" "balance" "--network=preprod"

[dotenv@17.2.2] injecting env (0) from ../.env.local -- tip: 🛠️  run anywhere with `dotenvx run -- yourcommand`
[dotenv@17.2.2] injecting env (31) from ../.env -- tip: 📡 auto-backup env with Radar: https://dotenvx.com/radar
[hf-cli] Using BLOCKFROST_API_KEY for preprod.
Address: addr_test1qrvr7ffc2xjxk4wn5vxflernwu76la8ruqgx4nrq5q6eplv5fpsna8q8hytqhepswuavuaqg83qtnkkrndtv3jxhd7fqtxr8p8
Total lovelace: 9955975350
Total ADA: 9955.97535
```

### 3.2 プロトコル初期化

`pnpm run hf -- init --project-id=00000000000000000000000000000002 --network=preprod`

初回実行では担保 UTxO を作成するトランザクションが送信されるため、完了まで 10〜30 秒ほど待つことがあります。コマンドが成功すると参照 UTxO の JSON が表示されるので、`PARAM_UTXO_PROJECT2=...` の形で `.env.local` や Vercel の環境変数に貼り付けます。同時に `public/data/dev-projects.json` の該当プロジェクトに最新の `policyId` が書き戻されます。

* Example
```shell
% pnpm run hf -- init --network=preprod  --project-id=00000000000000000000000000000003

> hf-cli@ hf /Users/mizuki/workspace/cardano-next/scripts
> node hf-cli.cjs "--" "init" "--network=preprod" "--project-id=00000000000000000000000000000003"

[dotenv@17.2.2] injecting env (0) from ../.env.local -- tip: 📡 observe env with Radar: https://dotenvx.com/radar
[dotenv@17.2.2] injecting env (31) from ../.env -- tip: ⚙️  specify custom .env file path with { path: '/custom/path/.env' }
[hf-cli] Using BLOCKFROST_API_KEY for preprod.
Booting protocol with settings: {
  lovelacePrice: 1969750,
  expectedAprNumerator: 1,
  expectedAprDenominator: 10,
  maturationTime: '2338311809',
  maxMints: '100'
}
tx to be submitted:  84a600d9010281825820470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f5000182a300581d70abe7765412495640682a8771ffd9d7012725e551a18646b38a5d131101821a001898a4a1581c9fcfe5637314aa9605d8a7086484f0a43fae9957a571948774dd680aa14001028201d8185869d8799f001a001e0e56d8799fd8799f581cd83f253851a46b55d3a30c9fe473773daff4e3e0106acc60a03590fdffd8799fd8799fd8799f581c9448613e9c07b9160be430773ace74083c40b9dac39b56c8c8d76f92ffffffffd87a80d87a80010a1a8b5fce811864ff82583900d83f253851a46b55d3a30c9fe473773daff4e3e0106acc60a03590fd9448613e9c07b9160be430773ace74083c40b9dac39b56c8c8d76f921a00272eb7021a000c83e509a1581c9fcfe5637314aa9605d8a7086484f0a43fae9957a571948774dd680aa140010b582011bb34b7d88c308fd3ef46f2d8d149921b47aa74ea9f9d2e6f9452323c94d4b60dd9010281825820470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f500a207d90102815901cc5901c901010033232323232323222533300332323232325332330093001300a37540042646464a66601860080022a66601e601c6ea8018540085854ccc030cdc3a40040022a66601e601c6ea8018540085858c030dd50028992999805980198061baa0051533300b3003300c375464660020026eb0c044c038dd50041129998080008a6103d87a800013232533300f3375e01c600a60226ea80084cdd2a40006602600497ae01330040040013014002301200114a229404c8cc004004c8cc004004dd59809180998099809980998079baa00922533301100114bd70099199911191980080080191299980b80088018991980c9ba733019375200c66032602c00266032602e00297ae033003003301b0023019001375c60200026eacc044004cc00c00cc054008c04c004894ccc040004528899299980719299980799b8f375c600a00200c266e20dd6980a180a980a800a40002944dd618098010998018018008a50301300123010001375c601c60166ea8008dc3a40002c6018601a004601600260160046012002600a6ea8004526136565734aae7555cf2ab9f5740ae855d1260127d8799f5820470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f500ff000105a182010082d87980821a006acfc01ab2d05e00f5f6
associated paramUtxo:  {
  outputIndex: 0,
  txHash: '470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f5'
}
Submitting oracle/settings UTXO setup transaction
Submitted oracle mint tx hash:  0d484267a53e633d318c4ef21aace22daa088ed6d630fbdbd8de6d9203232eb2
paramUtxo saved to /Users/mizuki/workspace/cardano-next/paramUtxo.json.
[hf-cli] Export the following environment variable:
PARAM_UTXO_RUMDUOL_DEV3='{
  "outputIndex": 0,
  "txHash": "470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f5"
}'
getOracleNFTCbor called
this.paramUtxo
{
  outputIndex: 0,
  txHash: '470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f5'
}
this.paramUtxo.txHash 470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f5
this.paramUtxo.txHash.length 64
params [
  {
    alternative: 0,
    fields: [
      '470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f5',
      0
    ]
  }
]
[hf-cli] Updated dev-projects.json policyId to 8633b281292f71ec17e93e577b40f4af23c5a04e1021547730ca8dfb.
Note: booting the protocol submits a transaction and consumes ADA for collateral/fees.
```

### 3.3 環境変数の変更

project.json の新規プロジェクトの設定項目 `paramUtxoEnvKey` の値 `PARAM_UTXO_PROJECT_2` に環境変数として
生成したJSONを設定する

```
PARAM_UTXO_RUMDUOL_DEV3='{"outputIndex": 0, "txHash": "470d2c164b14438951311201b4c4630cc822ee9fdb0ba2ceef941bc6ef0a51f5"}'
```

### 3.4 オラクル状態の確認(option)

`pnpm run hf -- o --project-id=00000000000000000000000000000002 --network=preprod`

このコマンドで obtained された datum を確認し、`nft_mint_allowed` が `true` であること、価格や供給上限が期待通りであることを確かめてください。

*Example
```shell
% pnpm run hf -- o --project-id=00000000000000000000000000000002 --network=preprod

> hf-cli@ hf /Users/mizuki/workspace/cardano-next/scripts
> node hf-cli.cjs "--" "o" "--project-id=00000000000000000000000000000002" "--network=preprod"

[dotenv@17.2.2] injecting env (0) from ../.env.local -- tip: 📡 observe env with Radar: https://dotenvx.com/radar
[dotenv@17.2.2] injecting env (31) from ../.env -- tip: ⚙️  suppress all logs with { quiet: true }
[hf-cli] Using BLOCKFROST_API_KEY for preprod.
getOracleNFTCbor called
this.paramUtxo
{
  outputIndex: 0,
  txHash: 'a745c8b8f9b6896fe73767095981548acbc5a9092b478f63bc575899a85083a8'
}
this.paramUtxo.txHash a745c8b8f9b6896fe73767095981548acbc5a9092b478f63bc575899a85083a8
this.paramUtxo.txHash.length 64
params [
  {
    alternative: 0,
    fields: [
      'a745c8b8f9b6896fe73767095981548acbc5a9092b478f63bc575899a85083a8',
      0
    ]
  }
]
getOracleNFTCbor called
this.paramUtxo
{
  outputIndex: 0,
  txHash: 'a745c8b8f9b6896fe73767095981548acbc5a9092b478f63bc575899a85083a8'
}
this.paramUtxo.txHash a745c8b8f9b6896fe73767095981548acbc5a9092b478f63bc575899a85083a8
this.paramUtxo.txHash.length 64
params [
  {
    alternative: 0,
    fields: [
      'a745c8b8f9b6896fe73767095981548acbc5a9092b478f63bc575899a85083a8',
      0
    ]
  }
]
{
  "nftIndex": 4,
  "policyId": "edadd1b8e4701bc71abd2ed8588a3a6b8c53ed92d5fc3eb4b312c372",
  "lovelacePrice": 1969750,
  "oracleUtxo": {
    "input": {
      "outputIndex": 0,
      "txHash": "660f3d2f52264c953918429a211c1f30a2d32788d08f3146012c47a4781bee00"
    },
    "output": {
      "address": "addr_test1wz47waj5zfy4vsrg92rhrl7e6uqjwf092xscv34n3fw3xygxvx0am",
      "amount": [
        {
          "unit": "lovelace",
          "quantity": "1491260"
        },
        {
          "unit": "b47acbfe0a994111f11f3f08ece1bfec72a6472792b92f595ab71aca",
          "quantity": "1"
        }
      ],
      "dataHash": "7857e7862075582cab6fa9168ff2cf27ee7dda88376e4b8f4901b2b2a7590ad6",
      "plutusData": "d8799f041a001e0e56d8799fd8799f581cd83f253851a46b55d3a30c9fe473773daff4e3e0106acc60a03590fdffd8799fd8799fd8799f581c9448613e9c07b9160be430773ace74083c40b9dac39b56c8c8d76f92ffffffffd87a80d87a80010a1a8b5fce811864ff",
      "scriptHash": null
    }
  },
  "oracleNftPolicyId": "b47acbfe0a994111f11f3f08ece1bfec72a6472792b92f595ab71aca",
  "feeCollectorAddress": "addr_test1qrvr7ffc2xjxk4wn5vxflernwu76la8ruqgx4nrq5q6eplv5fpsna8q8hytqhepswuavuaqg83qtnkkrndtv3jxhd7fqtxr8p8",
  "feeCollectorAddressObj": {
    "constructor": 0,
    "fields": [
      {
        "constructor": 0,
        "fields": [
          {
            "bytes": "d83f253851a46b55d3a30c9fe473773daff4e3e0106acc60a03590fd"
          }
        ]
      },
      {
        "constructor": 0,
        "fields": [
          {
            "constructor": 0,
            "fields": [
              {
                "constructor": 0,
                "fields": [
                  {
                    "bytes": "9448613e9c07b9160be430773ace74083c40b9dac39b56c8c8d76f92"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "nftMintAllowed": {
    "constructor": 1,
    "fields": []
  },
  "nftTradeAllowed": {
    "constructor": 1,
    "fields": []
  },
  "expectedAprNumerator": {
    "int": 1
  },
  "expectedAprDenominator": {
    "int": 10
  },
  "maturationTime": {
    "int": 2338311809
  },
  "maxMints": {
    "int": 100
  }
}
```

### 3.5 ミント許可の切り替え(option)

ミントを一時停止したいときは `pnpm run hf -- dm --project-id=...` を、再開したいときは停止後に `pnpm run hf -- em --project-id=...` を実行します。初期状態では既にミントが許可されているため、状態を変更せずに `em` を実行するとスクリプトが失敗します。必ず `dm` → `em` の順で状態遷移を行ってください。

### 3.5 ミント実行 & PolicyID の更新

実際に NFT をミントする場合は、`npm run dev` でフロントエンドを起動するか、サーバー API を直接呼び出します。
Note: 一度Mintした上で正しいPolicyIDを取得し、これをProject.Jsonに埋め込む
```
https://preprod.cexplorer.io/tx/70240f532f64d1ce308addba676d25fcc97edc0ae26cef3cbc4051e91acecac3?tab=content
```
より
```
ceabde290bb89db1dd21a816fb1d67404373248b9861c6421eabdecd
```

### 3.6 ホルダー確認

```
% pnpm run hf -- lh  --project-id=00000000000000000000000000000003 --network=preprod

> hf-cli@ hf /Users/mizuki/workspace/cardano-next/scripts
> node hf-cli.cjs "--" "lh" "--project-id=00000000000000000000000000000003" "--network=preprod"

[dotenv@17.2.2] injecting env (0) from ../.env.local -- tip: ⚙️  enable debug logging with { debug: true }
[dotenv@17.2.2] injecting env (32) from ../.env -- tip: ⚙️  override existing env vars with { override: true }
[hf-cli] Using BLOCKFROST_API_KEY for preprod.
[hf-cli] Using project policyId ceabde290bb89db1dd21a816fb1d67404373248b9861c6421eabdecd for holder lookup.
{
  "ceabde290bb89db1dd21a816fb1d67404373248b9861c6421eabdecd000de14048617276657374666c6f7720283029": [
    "addr_test1qr87g4a5jsg57ul36vnnn99aqddgkesawvgzjlshsxyhpxjngs2np8tlavv9w6xnz58snl0czq3ywsapt9dkqxpx738sthc6ty"
  ],
  "ceabde290bb89db1dd21a816fb1d67404373248b9861c6421eabdecd000de14048617276657374666c6f7720283129": [
    "addr_test1qr87g4a5jsg57ul36vnnn99aqddgkesawvgzjlshsxyhpxjngs2np8tlavv9w6xnz58snl0czq3ywsapt9dkqxpx738sthc6ty"
  ]
}
```

## 4. 環境変数の整理

| キー | 用途 |
| --- | --- |
| `PARAM_UTXO_<PROJECT>` | `init` の出力を設定します。Vercel の環境変数にも同じ名前で登録してください。 |
| `PAYMENT_MNEMONIC` | サーバー署名に使用する 24 語のニーモニックです。`.env.local` で管理してください。 |
| `PAYMENT_ACCOUNT_INDEX` / `PAYMENT_ADDRESS_INDEX` | Lace で複数アカウントを扱う場合に派生パスを合わせます。 |
| `PAYMENT_MNEMONIC_PASSPHRASE` | BIP39 パスフレーズを利用している場合のみ設定します。 |

## 5. 動作確認

`npm run dev` でアプリケーションを起動し、トップページに新しいプロジェクトが表示されることを確認してください。続いて `npm run lint` を実行し、静的解析をパスすることを確かめます。テストミントを行った後は `pnpm run hf -- lh` で保有者情報が取得できることを再確認し、`pnpm run hf -- balance` でウォレットに十分な ADA が残っているかもチェックします。

## 6. デプロイ

本番環境へ公開するときは、`public/data/projects.json` に同じエントリを追加します。`policyId` と `paramUtxoEnvKey` は本番用の値に置き換え、Vercel の環境変数も mainnet 用 (`BLOCKFROST_MAINNET_API_KEY` や `CARDANO_NETWORK=mainnet` など) に切り替えます。その上で `pnpm run hf -- init --project-id=... --network=mainnet` を実行し、本番用の参照 UTxO を作成してください。最後に Vercel へデプロイし、`pnpm run hf -- o --network=mainnet` で状態を確認します。

## 参考コマンド一覧

| コマンド | 説明 |
| --- | --- |
| `pnpm run hf -- balance --project-id=...` | 資金用ウォレットの残高を確認します。 |
| `pnpm run hf -- init --project-id=...` | プロトコルを初期化し、新しい param UTxO を生成します。 |
| `pnpm run hf -- o --project-id=...` | オラクルに記録されている価格や状態を確認します。 |
| `pnpm run hf -- em/dm --project-id=...` | ミントの許可状態を切り替えます。 |
| `pnpm run hf -- lh --project-id=...` | 最新の policyId に紐づく保有者一覧を表示します。 |

## トラブルシューティング

- `No collateral found` が表示された場合、担保 UTxO がまだ生成されていない可能性があります。トランザクションがブロックに含まれるまで数秒待ってから再実行してください。残高不足の場合は ADA を補充します。
- `ENOENT: open '/...{"txHash":...}'` が表示された場合、`.env` の `PARAM_UTXO_*` に余計なクォートが付いていることが原因です。純粋な JSON 文字列に修正してください。
- `Minting error: TxSignError` が表示された場合、ブラウザウォレットが必要な入力を保持していない可能性があります。正しいウォレットを選択するか、資金 UTxO を追加してください。
- `TxSubmitFail` が表示された場合、redeemer や datum の整合性に問題があります。エラーメッセージを確認し、`dm` → `em` の順で状態遷移を行ったか、価格などの設定に齟齬がないかを調べます。

上記の流れに従えば、新しいプロジェクトのオンチェーン設定から UI への反映、そしてデプロイまでを一貫した手順で行うことができます。
